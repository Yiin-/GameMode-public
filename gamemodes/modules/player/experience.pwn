#include <YSI_Coding\y_hooks>

static player_Experience[MAX_PLAYERS];
static player_Level[MAX_PLAYERS];

static const xp_table[] = {
	0x0,0x53,0xAE,0x114,0x184,0x200,0x28A,
	0x321,0x3C9,0x482,0x54E,0x630,0x729,0x83B,
	0x96B,0xABA,0xC2B,0xDC3,0xF85,0x1176,
	0x139A,0x15F8,0x1893,0x1B74,0x1EA2,0x2224,
	0x2602,0x2A48,0x2EFF,0x3433,0x39F1,0x4048,
	0x4747,0x4F00,0x5786,0x60EF,0x6B51,0x76C8,
	0x8370,0x9168,0xA0D3,0xB1D9,0xC4A3,0xD961,
	0xF048,0x1098F,0x12577,0x14446,0x16649,0x18BD5,
	0x1B549,0x1E30C,0x21592,0x24D58,0x28AEC,0x2CEE8,
	0x319F6,0x36CD2,0x3C84E,0x42D4E,0x49CD0,0x517EC,
	0x59FD7,0x635E7,0x6DB94,0x7927E,0x85C71,0x93B68,
	0xA3193,0xB415B,0xC6D6D,0xDB8B9,0xF267F,0x10BA56,
	0x127835,0x14647B,0x1683FD,0x18DC10,0x1B7298,
	0x1E4E14,0x2175B2,0x24F15F,0x28C9DA,0x2D08CD,
	0x31B8E2,0x36E5E0,0x3C9CC6,0x42EBF0,0x49E337,
	0x51941C,0x5A11EF,0x637205,0x6DCBED,0x7939A6,
	0x85D7E6,0x93C661,0xA32815,0xB423A6,0xC6E3BF,
	0xDB9778,0xF272D5,0x10BAF40,0x1278C20,0x1464F71,
	0x168467E,0x18DC698,0x1B72DF5,0x1E4E497,0x2175D56,
	0x24F16FD,0x28C9D89,0x2D08B89,0x31B8BA5,0x36E5A46,
	0x3C9C773,0x42EB8D8,0x49E2C0C,0x519390A,0x5A114F1,
	0x637150F,0x6DCB236,0x7938C74,0x85D6F24,0x93C5571,
	0xA326F51,0xB422704,0xC6E2724,0xDB96156,0xF2715B6,
	0x10BADAF9,0x1278A776,0x1464DB19,0x16844A61,
	0x18DC4A83,0x1B72BECA,0x1E4E276B,0x2175B1D2,
	0x24F14AAD,0x28C9B1D5,0x2D089047,0x31B8906A,
	0x36E578DA,0x3C9C49FC,0x42EB5EA9,0x49E2903F,
	0x51935E6E,0x5A111B31,0x63711B56,0x6DCAEC14,
	0x79388E36,0x85D6B770,0x93C51A79,0xA326B6B5,
	0xB4223018,0xC6E2303F,0xDB95D197,0xF27115B9,
	0xBAD6808,0x278A2DF8,0x464D664B,0x684458ED,
	0x8DC45915,0xB72B9BA1,0xE4E223BF,0x175AC838,
	0x4F1453F2,0x8C9AC473,0xD088A991,0x1B88A9BB,
	0x6E572EAC,0xC9C43EC0,0x2EB5878B,0x9E289ED7,
	0x19357FB2,0xA11149C6,0x371149F2,0xDCAE53AC,
	0x938873AB,0x5D6B0519,0x3C513388,0x326AF513,
	0x42228912,0x6E22893F,0xB95C9C89,0x2710DC5E,
	0xBAD5FF0E,0x78A25BC2,0x64D5DEAC,0x8445067E,
	0xDC4506AE,0x72B92D16,0x4E21AC93,0x75ABF1C7,
	0xF144AB01,0xC9ABB0AA,0x88A0020,0xB88A0051,
	0xE5724CF4,0x9C434BC1,0xEB57D5FA
};

hook OnCreatePlayerORM(ORM:ormid, playerid) {
	orm_addvar_int(ormid, player_Experience[playerid], "experience");
	orm_addvar_int(ormid, player_Level[playerid], "level");
}

hook OnResetPlayerVars(playerid) {
	player_Experience[playerid] = 0;
	player_Level[playerid] = 0;
}

ShallLevelUp(old_exp, new_exp) {
	new new_level = -1;

	if(new_exp > old_exp) {
		for(new i; i < sizeof xp_table; ++i) {
			if(old_exp < xp_table[i] && new_exp >= xp_table[i]) {
				new_level = i;
			}
		}
	}
	else {
		for(new i; i < sizeof xp_table - 1; ++i) {
			if(new_exp >= xp_table[i] && new_exp < xp_table[i + 1]) {
				new_level = i;
			}
		}
	}
	if(new_level <= 0) {
		new_level++;
	}
	return new_level;
}

GetPlayerLevel(playerid) {
	return player_Level[playerid];
}

AdjustPlayerExp(playerid, amount) {
	new oa = player_Experience[playerid];
	new na = player_Experience[playerid] += amount;

	new new_level;
	if((new_level = ShallLevelUp(oa, na))) {
		player_Level[playerid] = new_level;
	}
	return new_level;
}

GivePlayerExp(playerid, amount) {
	if(AdjustPlayerExp(playerid, amount)) {
		call OnPlayerLevelUp(playerid);
	}
	return GetPlayerExp(playerid);
}

GetPlayerExp(playerid) {
	return player_Experience[playerid];
}